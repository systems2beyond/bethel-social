rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.role == 'admin' || 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    // Public Data (Social Feed, Events, etc.)
    match /posts/{postId} {
      allow read: if true;
      allow write: if request.auth != null;
      
      match /comments/{commentId} {
        allow read: if true;
        allow write: if request.auth != null;

        match /likes/{likeId} {
          allow read: if true;
          allow write: if request.auth != null;
        }
      }
      
      match /likes/{likeId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }

    match /reports/{reportId} {
      allow read, write: if isAdmin();
    }
    
    match /sermon_chunks/{chunkId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    match /sermons/{sermonId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Groups Feature
    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null; // Refine later
      allow delete: if request.auth != null; // Refine later
      
      match /members/{memberId} {
        allow read, write: if request.auth != null;
      }
      
      match /posts/{postId} {
        allow read, write: if request.auth != null;
        
        match /likes/{likeId} {
            allow read: if true;
            allow write: if request.auth != null;
        }

        match /comments/{commentId} {
            allow read: if true;
            allow write: if request.auth != null;

            match /likes/{likeId} {
                allow read: if true;
                allow write: if request.auth != null;
            }
        }
      }
    }

    // Collection Group for My Groups
    match /{path=**}/members/{memberId} {
      allow read: if request.auth != null;
    }

    // User Private Data (Profile, Chat History)
    match /users/{userId} {
      // Allow any auth user to read profiles (for invitations), but only owner can write
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      match /chats/{chatId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        match /messages/{messageId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }

      match /sermon_notes/{sermonId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

        match /chat/{messageId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }

      // Settings (Bible, Theme, etc.)
      match /settings/{settingId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Unified Notes
      match /notes/{noteId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;

      
        match /chat/{messageId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }
      }
    }

    match /events/{eventId} {
      allow read: if true;
      allow write: if request.auth != null;

      match /registrations/{registrationId} {
        allow create: if request.auth != null;
        allow read, update, delete: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
      }

      match /ticket_configs/{configId} {
        allow read, write: if request.auth != null;
      }
    }

    // Google Meets & Chat Bridge
    match /meetings/{meetingId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;

      match /comments/{commentId} {
        allow read, write: if request.auth != null; // Allow participants to chat

        match /likes/{likeId} {
          allow read, write: if request.auth != null;
        }
      }
    }

    // Invitations (Shared Scrolls)
    match /invitations/{invitationId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.fromUser.uid == request.auth.uid;
      allow update, delete: if request.auth != null && (resource.data.toUserId == request.auth.uid || resource.data.fromUser.uid == request.auth.uid);
    }

    // Donations
    match /tickets/{ticketId} {
      allow read: if true; // Public can verify tickets
      allow write: if isAdmin(); // Only admins can manage tickets
    }
    
    match /campaigns/{campaignId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /donations/{donationId} {
      // Admins can read all. Users can read their own.
      allow read: if isAdmin() || (request.auth != null && resource.data.donorId == request.auth.uid);
      // Only allow writes from server/functions (admin SDK bypasses rules) or specific authorized clients if needed. 
      // For now, restrict client-side writes to be safe.
      allow write: if false; 
    }

    // Church Configuration (Public/Admin)
    match /churches/{churchId} {
      allow read: if true; // Allow public read for feature flags (dynamic landing pages, etc.)
      allow write: if isAdmin();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
